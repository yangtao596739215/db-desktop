# æµå¼å“åº”MCPå¤„ç†é€»è¾‘

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä¼˜åŒ–åçš„æµå¼å“åº”å¤„ç†é€»è¾‘ï¼Œè¯¥é€»è¾‘èƒ½å¤Ÿæ™ºèƒ½æ£€æµ‹æµå¼å“åº”ä¸­æ˜¯å¦åŒ…å«MCPï¼ˆModel Context Protocolï¼‰å·¥å…·è°ƒç”¨ï¼Œå¹¶ç›¸åº”åœ°è°ƒæ•´å¤„ç†ç­–ç•¥ã€‚

## å¤„ç†æµç¨‹

### 1. æµå¼å“åº”æ£€æµ‹

å½“AIæ¨¡å‹è¿”å›æµå¼å“åº”æ—¶ï¼Œç³»ç»Ÿä¼šå®æ—¶æ£€æµ‹å“åº”ä¸­æ˜¯å¦åŒ…å«å·¥å…·è°ƒç”¨ï¼š

```go
// åœ¨æµå¼å“åº”ä¸­æ£€æµ‹MCPè°ƒç”¨
if len(choice.Delta.ToolCalls) > 0 {
    hasMCP = true
    // æ£€æµ‹åˆ°å·¥å…·è°ƒç”¨ï¼Œæ ‡è®°ä¸ºMCPå“åº”
}
```

### 2. åˆ†æ”¯å¤„ç†é€»è¾‘

#### 2.1 æ— MCPè°ƒç”¨çš„æƒ…å†µ

- **å®æ—¶è¿”å›**: æµå¼å“åº”å†…å®¹å®æ—¶è¿”å›ç»™å‰ç«¯å±•ç¤º
- **æ¶ˆæ¯å­˜å‚¨**: æµå¼å“åº”ç»“æŸåï¼Œå°†å®Œæ•´çš„ç”¨æˆ·æ¶ˆæ¯å’ŒAIå›å¤ä¿å­˜åˆ°SQLiteæ•°æ®åº“

```go
if !hasMCP {
    // å¦‚æœæ²¡æœ‰MCPè°ƒç”¨ï¼Œç›´æ¥ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
    s.saveStreamMessageToDatabase(conversationID, message, fullContent)
}
```

#### 2.2 åŒ…å«MCPè°ƒç”¨çš„æƒ…å†µ

- **å®æ—¶è¿”å›**: æµå¼å“åº”å†…å®¹ä»ç„¶å®æ—¶è¿”å›ç»™å‰ç«¯å±•ç¤º
- **ç­‰å¾…å®Œæ•´å“åº”**: ç­‰å¾…æµå¼å“åº”å®Œå…¨ç»“æŸåï¼Œå†æ‰§è¡ŒMCPé€»è¾‘
- **é‡æ–°è¯·æ±‚**: ç”±äºæµå¼å“åº”ä¸­çš„å·¥å…·è°ƒç”¨ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´ï¼Œç³»ç»Ÿä¼šé‡æ–°å‘é€éæµå¼è¯·æ±‚ä»¥è·å–å®Œæ•´çš„å·¥å…·è°ƒç”¨ä¿¡æ¯
- **MCPå¤„ç†**: è·å–å®Œæ•´å·¥å…·è°ƒç”¨ä¿¡æ¯åï¼Œåˆ›å»ºç¡®è®¤å¡ç‰‡å¹¶æ‰§è¡Œç›¸åº”çš„æ•°æ®åº“æ“ä½œ

```go
if hasMCP {
    // å¦‚æœåŒ…å«MCPè°ƒç”¨ï¼Œç­‰å¾…æµå¼å“åº”ç»“æŸåå†å¤„ç†MCPé€»è¾‘
    s.handleStreamCompleteWithMCP(fullContent, conversationID)
}
```

### 3. æ ¸å¿ƒç»„ä»¶

#### 3.1 StreamResponseCallback

```go
type StreamResponseCallback struct {
    OnContent     func(string)                    // æ¯ä¸ªå†…å®¹å—çš„å®æ—¶å›è°ƒ
    OnComplete    func(string, bool)              // æµå¼å“åº”å®Œæˆå›è°ƒ (å†…å®¹, æ˜¯å¦æœ‰MCP)
    OnError       func(error)                    // é”™è¯¯å›è°ƒ
}
```

#### 3.2 ä¸»è¦æ–¹æ³•

- `SendMessageStreamWithCallback`: æ”¯æŒMCPæ£€æµ‹çš„æµå¼å“åº”å‘é€
- `handleStreamCompleteWithMCP`: å¤„ç†åŒ…å«MCPçš„æµå¼å“åº”å®Œæˆ
- `handleMCPAfterStream`: æµå¼å“åº”ç»“æŸåçš„MCPå¤„ç†
- `saveStreamMessageToDatabase`: ä¿å­˜æµå¼å“åº”æ¶ˆæ¯åˆ°æ•°æ®åº“

## ä¼˜åŠ¿

1. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: æ— è®ºæ˜¯å¦åŒ…å«MCPè°ƒç”¨ï¼Œç”¨æˆ·éƒ½èƒ½å®æ—¶çœ‹åˆ°AIçš„å›å¤å†…å®¹
2. **MCPå¤„ç†å®Œæ•´æ€§**: ç¡®ä¿MCPå·¥å…·è°ƒç”¨ä¿¡æ¯çš„å®Œæ•´æ€§ï¼Œé¿å…æµå¼å“åº”ä¸­ä¿¡æ¯ä¸å®Œæ•´çš„é—®é¢˜
3. **æ€§èƒ½ä¼˜åŒ–**: åªæœ‰åœ¨æ£€æµ‹åˆ°MCPè°ƒç”¨æ—¶æ‰è¿›è¡Œé¢å¤–çš„éæµå¼è¯·æ±‚
4. **æ•°æ®ä¸€è‡´æ€§**: ç»Ÿä¸€çš„æ¶ˆæ¯å­˜å‚¨é€»è¾‘ï¼Œç¡®ä¿æ•°æ®åº“ä¸­çš„æ•°æ®å®Œæ•´æ€§

## ä½¿ç”¨ç¤ºä¾‹

### å‰ç«¯è°ƒç”¨

```javascript
// å‰ç«¯è°ƒç”¨æµå¼å“åº”
await sendMessageToCurrentConversation(userMessage)
```

### åç«¯å¤„ç†

```go
// åç«¯ä½¿ç”¨æ–°çš„æµå¼å“åº”å¤„ç†
err := a.aiService.SendMessageStreamWithMCPDetection(message, conversation, conversationID, callback)
```

## æ—¥å¿—è¾“å‡º

ç³»ç»Ÿä¼šè¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯æ¥è·Ÿè¸ªå¤„ç†è¿‡ç¨‹ï¼š

```
ğŸ“¤ Streaming request details: url=..., method=POST, bodySize=..., stream=true
Stream completed - hasMCP: true, content length: 150
Stream response contains MCP calls, processing after stream completion
Handling stream completion with MCP: conversationID=...
MCP tool calls detected after stream completion
Stream message saved to database: conversationID=...
```

## æµ‹è¯•

ä½¿ç”¨æä¾›çš„æµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½ï¼š

```bash
./test_streaming_mcp.sh
```

è¯¥è„šæœ¬ä¼šæµ‹è¯•ï¼š
1. æ™®é€šæµå¼å“åº”ï¼ˆæ— MCPï¼‰
2. åŒ…å«MCPçš„æµå¼å“åº”ï¼ˆRedisï¼‰
3. åŒ…å«MCPçš„æµå¼å“åº”ï¼ˆMySQLï¼‰

## æ³¨æ„äº‹é¡¹

1. æµå¼å“åº”ä¸­çš„å·¥å…·è°ƒç”¨ä¿¡æ¯å¯èƒ½ä¸å®Œæ•´ï¼Œå› æ­¤éœ€è¦é‡æ–°å‘é€éæµå¼è¯·æ±‚
2. åªæœ‰åœ¨æ£€æµ‹åˆ°MCPè°ƒç”¨æ—¶æ‰ä¼šè¿›è¡Œé¢å¤–çš„å¤„ç†
3. æ¶ˆæ¯å­˜å‚¨ç»Ÿä¸€åœ¨æµå¼å“åº”ç»“æŸåè¿›è¡Œï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§
4. å‰ç«¯æ— éœ€ä¿®æ”¹ï¼Œç°æœ‰çš„æµå¼å“åº”å¤„ç†é€»è¾‘ä»ç„¶æœ‰æ•ˆ
